<!-- chat.html -->
<!DOCTYPE html>
<html>
<head>
    <title>éšå¿ƒ - æˆ¿é—´</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* å¼¹å‡ºæ–‡å­—æ ·å¼ */
        .pop-text {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) scale(0.6);
            font-size: 100px;
            font-weight: bold;
            color: #FF6B6B;
            opacity: 0;
            pointer-events: none;
            z-index: 9999;
            font-family: "STXingkai", "Xingkai SC", "PingFang SC",
            "Kaiti SC",
            "KaiTi",
            "STKaiti",
            "æ¥·ä½“",
            serif;
            animation: popScale 2s ease-out forwards;
        }

        /* ç¼©æ”¾åŠ¨ç”» */
        @keyframes popScale {
            0% {
                transform: translate(-50%, -50%) scale(0.6);
                opacity: 0;
            }
            40% {
                transform: translate(-50%, -50%) scale(1.25);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
            padding: 0;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: white;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .room-info {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 0;
        }

        .room-title {
            font-size: 1.4rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .room-id {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 3px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .player-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.85rem;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .user-info:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .user-color {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid white;
        }

        #usernameDisplay {
            font-weight: 600;
            font-size: 1rem;
            white-space: nowrap;
        }

        .main-content {
            display: flex;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        /* å·¦ä¾§æ¸¸æˆåŒºåŸŸ (2/3) */
        .left-game {
            flex: 2;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-right: 1px solid #d1d8e0;
            min-width: 0;
            overflow-y: auto;
        }

        .left-header {
            padding: 12px 20px;
            border-bottom: 1px solid #d1d8e0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-weight: 600;
            color: white;
            font-size: 0.95rem;
            flex-shrink: 0;
            /* æ ¸å¿ƒæ–°å¢ï¼šæ¨ªå‘æ’åˆ— + å‚ç›´å±…ä¸­ï¼ŒFlexé»˜è®¤å°±æ˜¯æ¨ªå‘row */
            display: flex;
            align-items: center;
            /* å¯é€‰ï¼šæ§åˆ¶å†…éƒ¨å…ƒç´ é—´è·ï¼Œæ ¹æ®éœ€æ±‚åŠ ï¼Œæ¯”å¦‚é—´è·8px */
            gap: 8px;
            /* å¯é€‰ï¼šå†…éƒ¨å…ƒç´ é å·¦/å±…ä¸­/é å³ï¼Œé»˜è®¤é å·¦ï¼ŒæŒ‰éœ€å–æ¶ˆæ³¨é‡Š */
            /* justify-content: center; å±…ä¸­ */
            /* justify-content: flex-end; é å³ */
        }

        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 20px;
        }

        /* å¯¹æ‰‹ç‰ŒåŒº */
        .opponent-area {
            flex: 2;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 20px;
            border: 2px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .area-title {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .opponent-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
            flex: 1;
            min-height: 100px;
        }

        /* è‡ªå·±æ‰‹ç‰ŒåŒº */
        .my-area {
            flex: 2;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 20px;
            border: 2px solid #667eea;
            display: flex;
            flex-direction: column;
        }

        .my-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
            flex: 1;
            min-height: 120px;
        }

        /* éº»å°†ç‰Œä¸»æ ·å¼ï¼šç´«è‰²æ¸å˜+ä¿ç•™åŸæœ‰äº¤äº’å¸ƒå±€ */
        .hand-card {
            width: 70px;
            height: 100px;
            /* æ ¸å¿ƒä¿®æ”¹1ï¼šç´«è‰²æ¸å˜èƒŒæ™¯ï¼ˆæµ…ç´«â†’æ·±ç´«ï¼Œ135åº¦å’ŒåŸå…‰å½±ä¸€è‡´ï¼Œç™½å­—å¯¹æ¯”åº¦æ‹‰æ»¡ï¼‰ */
            background: linear-gradient(135deg, #06D6A0 0%, #118AB2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            /* æ¶ˆé™¤çˆ¶å®¹å™¨å¯èƒ½çš„å†…è¾¹è·ï¼Œç¡®ä¿å­å…ƒç´ æ»¡æ ¼ */
            padding: 0;
            margin: 0;
        }

        .hand-card1 {
            width: 70px;
            height: 100px;
            /* æ ¸å¿ƒä¿®æ”¹1ï¼šç´«è‰²æ¸å˜èƒŒæ™¯ï¼ˆæµ…ç´«â†’æ·±ç´«ï¼Œ135åº¦å’ŒåŸå…‰å½±ä¸€è‡´ï¼Œç™½å­—å¯¹æ¯”åº¦æ‹‰æ»¡ï¼‰ */
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FF8C00 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            /* æ¶ˆé™¤çˆ¶å®¹å™¨å¯èƒ½çš„å†…è¾¹è·ï¼Œç¡®ä¿å­å…ƒç´ æ»¡æ ¼ */
            padding: 0;
            margin: 0;
        }

        .hand-card2 {
            width: 70px;
            height: 100px;
            /* æ ¸å¿ƒä¿®æ”¹1ï¼šç´«è‰²æ¸å˜èƒŒæ™¯ï¼ˆæµ…ç´«â†’æ·±ç´«ï¼Œ135åº¦å’ŒåŸå…‰å½±ä¸€è‡´ï¼Œç™½å­—å¯¹æ¯”åº¦æ‹‰æ»¡ï¼‰ */
            background: linear-gradient(135deg, #6A1B9A 0%, #3A0F66 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            /* æ¶ˆé™¤çˆ¶å®¹å™¨å¯èƒ½çš„å†…è¾¹è·ï¼Œç¡®ä¿å­å…ƒç´ æ»¡æ ¼ */
            padding: 0;
            margin: 0;
        }

        /* éº»å°†å­—ç¬¦å®¹å™¨ï¼šæ ¸å¿ƒå®ç°å•ä¸ªå­—ç¬¦å æ»¡å…¨æ ¼ï¼ˆå¿…é¡»é…åˆè¿™ä¸ªç±»ï¼ï¼‰ */
        .hand-card-number {
            /* æ ¸å¿ƒï¼šæ’‘æ»¡çˆ¶å®¹å™¨.hand-cardçš„100%å®½é«˜ */
            width: 100%;
            height: 100%;
            /* å­—ç¬¦ç»å¯¹å±…ä¸­ï¼Œæ¶ˆé™¤ä¸Šä¸‹å·¦å³ç©ºéš™ */
            display: flex;
            align-items: center;
            justify-content: center;
            /* æ ¸å¿ƒ2ï¼šç²¾å‡†å­—ä½“å¤§å°ï¼Œ70Ã—100ç‰Œé¢æ»¡æ ¼ä¸æº¢å‡ºçš„é»„é‡‘å€¼ */
            font-size: 70px;
            /* æ¶ˆé™¤å­—ç¬¦é»˜è®¤è¡Œé«˜ç©ºéš™ï¼Œè®©å­—ç¬¦å®Œå…¨è´´ç´§ä¸Šä¸‹ */
            line-height: 1;
            /* å¯é€‰ï¼šåŠ æ–‡å­—é˜´å½±ï¼Œç´«è‰²èƒŒæ™¯ä¸Šå­—ç¬¦æ›´ç«‹ä½“ */
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .hand-card-number1 {
            /* æ ¸å¿ƒï¼šæ’‘æ»¡çˆ¶å®¹å™¨.hand-cardçš„100%å®½é«˜ */
            width: 100%;
            height: 100%;
            /* å­—ç¬¦ç»å¯¹å±…ä¸­ï¼Œæ¶ˆé™¤ä¸Šä¸‹å·¦å³ç©ºéš™ */
            display: flex;
            align-items: center;
            justify-content: center;
            /* æ ¸å¿ƒ2ï¼šç²¾å‡†å­—ä½“å¤§å°ï¼Œ70Ã—100ç‰Œé¢æ»¡æ ¼ä¸æº¢å‡ºçš„é»„é‡‘å€¼ */
            font-size: 40px;
            /* æ¶ˆé™¤å­—ç¬¦é»˜è®¤è¡Œé«˜ç©ºéš™ï¼Œè®©å­—ç¬¦å®Œå…¨è´´ç´§ä¸Šä¸‹ */
            line-height: 1;
            /* å¯é€‰ï¼šåŠ æ–‡å­—é˜´å½±ï¼Œç´«è‰²èƒŒæ™¯ä¸Šå­—ç¬¦æ›´ç«‹ä½“ */
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .hand-card.hand-card1.hand-card2:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        .hand-card-value {
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* å³ä¾§èŠå¤©æ¶ˆæ¯åŒº (1/3) */
        .right-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
            min-width: 0;
        }

        .right-header {
            padding: 12px 20px;
            border-bottom: 1px solid #e9ecef;
            background: #e9ecef;
            font-weight: 600;
            color: #495057;
            font-size: 0.95rem;
            flex-shrink: 0;
        }

        #messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        /* æ‰‹æœºç«–å±å¸ƒå±€ */
        @media (max-width: 768px) and (orientation: portrait) {
            .main-content {
                flex-direction: column;
            }

            .left-game,
            .right-chat {
                flex: none;
                height: 50%;
            }

            .left-game {
                border-right: none;
                border-bottom: 1px solid #d1d8e0;
            }

            .header {
                padding: 12px 15px;
                flex-wrap: wrap;
                gap: 10px;
            }

            .room-title {
                font-size: 1.2rem;
            }

            .user-info {
                padding: 6px 12px;
            }
        }

        /* å¹³æ¿å’Œæ¡Œé¢å¸ƒå±€ */
        @media (min-width: 769px) and (orientation: landscape) {
            .main-content {
                flex-direction: row;
            }

            .left-game {
                flex: 2;
            }

            .right-chat {
                flex: 1;
            }
        }

        /* ç¾åŒ–æ»šåŠ¨æ¡ */
        #messages::-webkit-scrollbar {
            width: 6px;
        }

        #messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        #messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        #messages::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .message {
            margin-bottom: 10px;
            padding: 10px 14px;
            border-radius: 12px;
            word-wrap: break-word;
            animation: messageAppear 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* èŠå¤©æ¶ˆæ¯æ ·å¼ */
        .message.chat {
            max-width: 85%;
        }

        .message.own {
            margin-left: auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.other {
            background: white;
            color: #1c1e21;
            border-left: 4px solid;
        }

        .message.system-game {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #bbdefb;
            font-size: 0.9rem;
            text-align: center;
            margin: 10px 0;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .message.history-info {
            background: #f3e5f5;
            color: #7b1fa2;
            border: 1px dashed #e1bee7;
            font-size: 0.8rem;
            text-align: center;
            margin: 10px 0;
        }

        .message.error {
            background: #fff5f5;
            color: #c53030;
            border: 1px solid #fed7d7;
            font-size: 0.85rem;
            text-align: center;
            margin: 10px 0;
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            font-size: 0.75rem;
        }

        .message-username {
            font-weight: 600;
            margin-right: 6px;
        }

        .message-time {
            opacity: 0.7;
            font-size: 0.7rem;
        }

        .message-content {
            line-height: 1.4;
            font-size: 0.9rem;
        }

        .input-area {
            padding: 15px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        #messageInput {
            flex: 1;
            padding: 12px 18px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            outline: none;
        }

        #messageInput:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.3rem;
        }

        .modal input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.95rem;
            margin-bottom: 20px;
        }

        .modal input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 10px;
        }

        /* ç”¨æˆ·åˆ—è¡¨æ ·å¼ */
        .user-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 5px;
        }

        .user-tag {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            background: white;
            border-radius: 15px;
            font-size: 0.8rem;
            border: 1px solid #e9ecef;
        }

        .user-color-small {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* æ¸¸æˆçŠ¶æ€æ ·å¼ */
        .game-status {
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-top: 5px;
            border: 1px solid #e9ecef;
        }

        .current-turn {
            font-weight: bold;
            color: #667eea;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.7;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0.7;
            }
        }

        /* æ•°å­—å¡ç‰‡æ ·å¼ */
        .card-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .card-value {
            font-size: 0.9rem;
            color: #666;
        }

        .player-badge1 {
            /* åŸæœ‰æ ·å¼ */
            background: linear-gradient(135deg, #ff6b81 0%, #ff4757 100%);
            padding: 5px 40px; /* å·¦å³åŸºç¡€é—´è·30px */
            border-radius: 20px;
            font-size: 1rem;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 5px;
            /* æ–°å¢ */
            cursor: pointer; /* é¼ æ ‡ç§»ä¸Šå»å˜æ‰‹å‹ï¼Œæç¤ºå¯ç‚¹å‡» */
            transition: background 0.2s; /* èƒŒæ™¯è¿‡æ¸¡ï¼Œæ›´ä¸æ»‘ */
        }

        /* é¼ æ ‡æ‚¬åœæ•ˆæœ */
        .player-badge1:hover {
            background: rgba(255, 255, 255, 0.3); /* æ‚¬åœå˜äº®ä¸€ç‚¹ */
        }
    </style>
</head>
<body>
<div class="pop-text"></div>
<div class="container">
    <div class="header">
        <div class="header-left">
            <button class="back-button" onclick="goBack()">â¬…</button>
            <div class="room-info">
                <div class="room-title" id="roomTitle">åŒéº»</div>
                <div class="room-id">
                    <span id="roomId">#000</span>
                    <span class="player-badge">ğŸ‘¥ <span id="onlineCount">0</span>/2</span>
                    <div class="user-list" id="userListContainer"></div>

                </div>
            </div>
        </div>
        <div class="user-info" onclick="showRenameModal()">
            <div id="userColor" class="user-color"></div>
            <span id="usernameDisplay">ç”¨æˆ·</span>
        </div>
    </div>

    <div class="main-content">
        <!-- å·¦ä¾§æ¸¸æˆåŒºåŸŸ (2/3) -->
        <div class="left-game">
            <div class="pop-text"></div>
            <div class="left-header">
                <span>éº»å°†</span>
                <div class="player-badge1" id="prepareBadge">
                    <span>ç‚¹å‡»å‡†å¤‡</span>
                </div>
            </div>
            <div class="game-area">
                <!-- å¯¹æ‰‹ç‰ŒåŒº -->
                <div class="opponent-area">
                    <div class="area-title">
                        <span>å¯¹æ‰‹æ‰‹ç‰ŒåŒº</span>
                    </div>
                    <div class="opponent-cards" id="opponentCards">
                    </div>
                </div>

                <!-- å¼ƒç‰ŒåŒº -->
                <div class="my-area">
                    <div class="area-title">
                        <span>å¼ƒç‰ŒåŒº</span>
                    </div>
                    <div class="my-cards" id="discardPile">
                    </div>
                </div>

                <!-- è‡ªå·±æ‰‹ç‰ŒåŒº -->
                <div class="my-area">
                    <div class="area-title">
                        <span>æˆ‘çš„æ‰‹ç‰ŒåŒº</span>
                    </div>
                    <div class="my-cards" id="myCards">
                        <!-- æ‰‹ç‰Œå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§èŠå¤©æ¶ˆæ¯åŒº (1/3) -->
        <div class="right-chat">
            <div class="right-header">
                <span>èŠå¤©</span>
            </div>
            <div id="messages"></div>
        </div>
    </div>

    <!-- è¾“å…¥åŒº -->
    <div class="input-area">
        <input type="text" id="messageInput" placeholder="è¾“å…¥èŠå¤©æ¶ˆæ¯..." autocomplete="off">
        <button id="sendButton" onclick="sendMessage()">å‘é€</button>
    </div>
</div>

<!-- ä¿®æ”¹ç”¨æˆ·åæ¨¡æ€æ¡† -->
<div id="renameModal" class="modal">
    <div class="modal-content">
        <h2>ä¿®æ”¹ç©å®¶åç§°</h2>
        <input type="text" id="renameInput" placeholder="è¾“å…¥æ–°ç©å®¶åç§°" maxlength="20">
        <div class="modal-buttons">
            <button onclick="renameUser()">ç¡®è®¤</button>
            <button onclick="hideRenameModal()">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script>
    const discardPileContainer = document.getElementById('discardPile');
    const readyBtn = document.getElementById('prepareBadge');
    const popText = document.querySelector('.pop-text');
    // ç»‘å®šç‚¹å‡»äº‹ä»¶
    readyBtn.addEventListener('click', function () {
        this.disabled = true;
        if (isNewGame === true) {
            isNewGame = false;
            gameState.isNew = false;
        }
        updateHandCards()
    });

    let ws = null;
    let currentUser = {
        id: '',
        username: '',
        color: '',
    };
    let playerNumber = 0;
    let roomID = '';
    let roomName = '';
    let userList = [];
    let hasReceivedHistory = false;
    let gameState = {
        discardPile: [],     // å¼ƒç‰Œå †
    };
    let isNewGame = true;
    const mahjongMap = {
        // é£ç‰Œ 1-4ï¼šä¸œã€å—ã€è¥¿ã€åŒ—
        31: 'ğŸ€€', 33: 'ğŸ€', 35: 'ğŸ€‚', 37: 'ğŸ€ƒ',
        // ç®­ç‰Œ 5-7ï¼šçº¢ä¸­ã€å‘è´¢ã€ç™½æ¿
        39: 'ğŸ€„', 41: 'ğŸ€…', 43: 'ğŸ€†',
        // ä¸‡å­ 8-16ï¼šä¸€ä¸‡~ä¹ä¸‡
        1: 'ğŸ€‡', 2: 'ğŸ€ˆ', 3: 'ğŸ€‰', 4: 'ğŸ€Š', 5: 'ğŸ€‹', 6: 'ğŸ€Œ', 7: 'ğŸ€', 8: 'ğŸ€', 9: 'ğŸ€',
        // ç‰¹æ®Šç‰Œ 43ï¼šç™¾æ­ï¼Œ0ï¼šç‰ŒèƒŒï¼ˆæ ¸å¿ƒï¼švisible=falseæ—¶æ˜¾ç¤ºï¼‰
        0: 'ğŸ€«'
    };
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.onload = function () {
        loadUserInfo();
        loadRoomInfo();
        connect();
        setupEventListeners();
    };

    function setupEventListeners() {
        // æŒ‰Enteré”®å‘é€æ¶ˆæ¯
        document.getElementById('messageInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // æŒ‰Escé”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                hideRenameModal();
            }
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function (event) {
            const modal = document.getElementById('renameModal');
            if (event.target === modal) {
                hideRenameModal();
            }
        };

        // å¤„ç†çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', handleResize);
        handleResize();
    }

    function handleResize() {
        const mainContent = document.querySelector('.main-content');
        const isPortrait = window.innerWidth <= 768;

        if (isPortrait) {
            mainContent.style.flexDirection = 'column';
        } else {
            mainContent.style.flexDirection = 'row';
        }
    }

    function goBack() {
        if (confirm('ç¡®å®šè¦ç¦»å¼€æ¸¸æˆæˆ¿é—´å—ï¼Ÿ')) {
            window.location.href = '/';
        }
    }

    function loadUserInfo() {
        // ä»URLå‚æ•°è·å–ç”¨æˆ·åï¼Œå¦åˆ™ä»localStorageè¯»å–
        const urlParams = new URLSearchParams(window.location.search);
        let username = urlParams.get('username');

        if (!username) {
            username = localStorage.getItem('chat_username');
            if (!username) {
                username = generateRandomName();
                localStorage.setItem('chat_username', username);
            }
        } else {
            // ä¿å­˜URLä¸­çš„ç”¨æˆ·ååˆ°localStorage
            localStorage.setItem('chat_username', username);
        }

        // ç”Ÿæˆæˆ–è·å–ç”¨æˆ·ID
        let userID = localStorage.getItem('chat_user_id');
        if (!userID) {
            userID = generateUserID();
            localStorage.setItem('chat_user_id', userID);
        }

        currentUser.id = userID;
        currentUser.username = username;
        currentUser.color = generateUserColor(userID);

        updateUserDisplay();
    }

    function loadRoomInfo() {
        const urlParams = new URLSearchParams(window.location.search);
        roomID = urlParams.get('room');

        if (!roomID || roomID.length !== 3) {
            showErrorMessage('æ— æ•ˆçš„æˆ¿é—´å·');
            setTimeout(() => {
                window.location.href = '/';
            }, 2000);
            return;
        }

        // å°è¯•ä»URLè·å–æˆ¿é—´åï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤
        roomName = urlParams.get('name') || `æˆ¿é—´ ${roomID}`;

        document.getElementById('roomTitle').textContent = roomName;
        document.getElementById('roomId').textContent = `#${roomID}`;

        // ä¿®æ”¹é¡µé¢æ ‡é¢˜
        document.title = `${roomName} #${roomID}`;
    }

    function generateUserID() {
        return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function generateRandomName() {
        const adjectives = ['å‹‡æ•¢çš„', 'èªæ˜çš„', 'å¿«ä¹çš„', 'å®‰é™çš„', 'æ´»æ³¼çš„', 'ç¥ç§˜çš„', 'ä¼˜é›…çš„', 'çƒ­æƒ…çš„'];
        const nouns = ['å°çŒ«', 'å°ç‹—', 'ç†ŠçŒ«', 'è€è™', 'ç‹®å­', 'ä¼é¹…', 'æµ·è±š', 'è´è¶'];
        const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
        const noun = nouns[Math.floor(Math.random() * nouns.length)];
        return adj + noun;
    }

    function generateUserColor(userID) {
        const colors = [
            '#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0',
            '#118AB2', '#073B4C', '#EF476F', '#7209B7',
            '#3A86FF', '#FB5607', '#8338EC', '#FF006E'
        ];
        let sum = 0;
        for (let i = 0; i < userID.length; i++) {
            sum += userID.charCodeAt(i);
        }
        return colors[sum % colors.length];
    }

    function updateUserDisplay() {
        document.getElementById('usernameDisplay').textContent = currentUser.username;
        document.getElementById('userColor').style.backgroundColor = currentUser.color;
    }

    function updateUserListDisplay(users) {
        const userListContainer = document.getElementById('userListContainer');
        userListContainer.innerHTML = '';

        users.forEach((user) => {
            const userTag = document.createElement('div');
            userTag.className = 'user-tag';
            userTag.innerHTML = `
                <div class="user-color-small" style="background-color: ${user.color}"></div>
                <span>${playerNumber ? `#${playerNumber} ` : ''}${user.username}</span>
                ${playerNumber === gameState.currentTurn ? 'ğŸ®' : ''}
            `;
            userListContainer.appendChild(userTag);
        });
    }

    function drawCard(hands) {
        if (gameState.deck.length < 1) {
            gameState.gameAction = `èƒ¡`;
        } else {
            const firstItem = gameState.deck.shift();
            hands.push(firstItem);
            gameState.gameAction = ``;
            gameState.littleTurn = 1;
        }
        sendGame()
    }

    function extraCard(extra, hands, card1, card2, card3) {
        hands.push(gameState.discard[gameState.discard.length - 1]);
        gameState.discard.pop();
        extra.push(card1, card2, card3);
        removeNumOnce(hands, card1);
        removeNumOnce(hands, card2);
        removeNumOnce(hands, card3);
        hands.sort((a, b) => a - b);
        gameState.littleTurn = 1;
        if (card1 === card2) {
            gameState.gameAction = `ç¢°`;
        } else {
            gameState.gameAction = `åƒ`;
        }
        sendGame();
    }

    function gangCard0(extra, hands, theDiscard) {
        gameState.discard.pop();
        extra.push(theDiscard, theDiscard, theDiscard);
        removeNumOnce(hands, theDiscard);
        removeNumOnce(hands, theDiscard);
        removeNumOnce(hands, theDiscard);
        const firstItem = gameState.deck.shift();
        hands.push(firstItem);
        gameState.gameAction = `æ `;
        gameState.littleTurn = 1;
        sendGame()
    }

    function gangCard1(hands, card) {
        removeNumOnce(hands, card);
        const firstItem = gameState.deck.shift();
        hands.push(firstItem);
        gameState.gameAction = `æ `;
        gameState.littleTurn = 1;
        sendGame()
    }

    function gang2Card(extra, hands, card) {
        extra.push(card, card, card);
        removeNumOnce(hands, card);
        removeNumOnce(hands, card);
        removeNumOnce(hands, card);
        removeNumOnce(hands, card);
        const firstItem = gameState.deck.shift();
        hands.push(firstItem);
        gameState.gameAction = `æ `;
        gameState.littleTurn = 1;
        sendGame()
    }

    function updateHandCards() {
        if (gameState.currentTurn === playerNumber) {
            readyBtn.innerText = 'æˆ‘æ–¹å›åˆ';
        } else {
            readyBtn.innerText = 'ç­‰å¾…å¯¹æ‰‹';
        }

        const myCardsContainer = document.getElementById('myCards');
        const opponentCards = document.getElementById('opponentCards');

        myCardsContainer.innerHTML = '';
        opponentCards.innerHTML = '';
        // å‡è®¾ currentUserSeatIndex æ˜¯å½“å‰ç”¨æˆ·åœ¨ gameState.hands ä¸­çš„ç´¢å¼•
        // è¿™å¯èƒ½éœ€è¦æ ¹æ®ä½ çš„æ¸¸æˆé€»è¾‘æ¥ç¡®å®š
        let hands = gameState.hands;
        let extra = gameState.extra;
        let hands1 = gameState.hands1;
        let extra1 = gameState.extra1;
        if (playerNumber === 1) {
            hands = gameState.hands1;
            extra = gameState.extra1;
            hands1 = gameState.hands;
            extra1 = gameState.extra;
        }
        extra.forEach((card) => {
            const cardElement = document.createElement('div');
            cardElement.className = 'hand-card2';
            cardElement.innerHTML = `
                <div class="hand-card-number">${mahjongMap[card] || mahjongMap[0]}</div>
            `;
            myCardsContainer.appendChild(cardElement);
        });
        hands.forEach((card) => {
            const cardElement = document.createElement('div');
            cardElement.className = 'hand-card';
            cardElement.innerHTML = `
                <div class="hand-card-number">${mahjongMap[card] || mahjongMap[0]}</div>
            `;
            cardElement.onclick = () => playCard(hands, card);
            myCardsContainer.appendChild(cardElement);
        });
        extra1.forEach((card) => {
            const cardElement = document.createElement('div');
            cardElement.className = 'hand-card2';
            cardElement.innerHTML = `
                <div class="hand-card-number">${mahjongMap[card] || mahjongMap[0]}</div>
            `;
            opponentCards.appendChild(cardElement);
        });
        hands1.forEach((card) => {
            const cardElement = document.createElement('div');
            cardElement.className = 'hand-card';
            if (gameState.gameAction !== `èƒ¡`) {
                cardElement.innerHTML = `
                <div class="hand-card-number">${mahjongMap[0]}</div>
            `;
            } else {
                cardElement.innerHTML = `
                <div class="hand-card-number">${mahjongMap[card]}</div>
            `;
            }
            opponentCards.appendChild(cardElement);
        });
        discardPileContainer.innerHTML = '';
        gameState.discard.forEach((card) => {
            const cardElement = document.createElement('div');
            cardElement.className = 'hand-card';
            cardElement.innerHTML = `
                <div class="hand-card-number">${mahjongMap[card]}</div>
            `;
            discardPileContainer.appendChild(cardElement);
        });

        if (playerNumber === gameState.currentTurn && gameState.gameAction !== `èƒ¡`) {
            if (gameState.littleTurn === 0) {
                const newArr = [...hands, gameState.discard[gameState.discard.length - 1]];
                const theDiscard = gameState.discard[gameState.discard.length - 1];
                if (isHu(newArr)) {
                    gameState.gameAction = `èƒ¡`;
                    sendGame();
                    return;
                }
                let drawBtn = false;
                if (hands.includes(theDiscard - 2) && hands.includes(theDiscard - 1)) {
                    drawBtn = true;
                    const cardElement = document.createElement('div');
                    cardElement.className = 'hand-card1';
                    cardElement.innerHTML = `
                        <div class="hand-card-number1">åƒ${mahjongMap[theDiscard - 2]}${mahjongMap[theDiscard - 1]}${mahjongMap[theDiscard]}</div>
                    `;
                    cardElement.onclick = () => extraCard(extra, hands, theDiscard - 2, theDiscard - 1, theDiscard);
                    discardPileContainer.appendChild(cardElement);
                }
                if (hands.includes(theDiscard - 1) && hands.includes(theDiscard + 1)) {
                    drawBtn = true;
                    const cardElement = document.createElement('div');
                    cardElement.className = 'hand-card1';
                    cardElement.innerHTML = `
                        <div class="hand-card-number1">åƒ${mahjongMap[theDiscard - 1]}${mahjongMap[theDiscard]}${mahjongMap[theDiscard + 1]}</div>
                    `;
                    cardElement.onclick = () => extraCard(extra, hands, theDiscard - 1, theDiscard, theDiscard + 1);
                    discardPileContainer.appendChild(cardElement);
                }
                if (hands.includes(theDiscard + 1) && hands.includes(theDiscard + 2)) {
                    drawBtn = true;
                    const cardElement = document.createElement('div');
                    cardElement.className = 'hand-card1';
                    cardElement.innerHTML = `
                        <div class="hand-card-number1">åƒ${mahjongMap[theDiscard]}${mahjongMap[theDiscard + 1]}${mahjongMap[theDiscard + 2]}</div>
                    `;
                    cardElement.onclick = () => extraCard(extra, hands, theDiscard, theDiscard + 1, theDiscard + 2);
                    discardPileContainer.appendChild(cardElement);
                }
                const count = newArr.filter(i => i === theDiscard).length;
                if (count > 2) {
                    drawBtn = true;
                    const cardElement = document.createElement('div');
                    cardElement.className = 'hand-card1';
                    cardElement.innerHTML = `
                        <div class="hand-card-number1">ç¢°${mahjongMap[theDiscard]}</div>
                    `;
                    cardElement.onclick = () => extraCard(extra, hands, theDiscard, theDiscard, theDiscard);
                    discardPileContainer.appendChild(cardElement);
                }
                if (count > 3) {
                    drawBtn = true;
                    const cardElement = document.createElement('div');
                    cardElement.className = 'hand-card1';
                    cardElement.innerHTML = `
                        <div class="hand-card-number1">æ ${mahjongMap[theDiscard]}</div>
                    `;
                    cardElement.onclick = () => gangCard0(extra, hands, theDiscard);
                    discardPileContainer.appendChild(cardElement);
                }
                if (drawBtn) {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'hand-card1';
                    cardElement.innerHTML = `
                        <div class="hand-card-number1">æ‘¸ç‰Œ</div>
                    `;
                    cardElement.onclick = () => drawCard(hands);
                    discardPileContainer.appendChild(cardElement);
                } else {
                    drawCard(hands);
                }
            } else {
                const newArr = [...hands];
                if (isHu(newArr)) {
                    gameState.gameAction = `èƒ¡`;
                    sendGame();
                    return;
                }
                for (let i = 0; i < extra.length - 2; i += 3) {
                    if (extra[i] === extra[i + 2]) {
                        if (hands.includes(extra[i])) {
                            const cardElement = document.createElement('div');
                            cardElement.className = 'hand-card1';
                            cardElement.innerHTML = `
                                <div class="hand-card-number1">æ ${mahjongMap[extra[i]]}</div>
                            `;
                            cardElement.onclick = () => gangCard1(hands, extra[i]);
                            discardPileContainer.appendChild(cardElement);
                        }
                    }
                }
                newArr.sort((a, b) => a - b);
                for (let i = 0; i < newArr.length - 3; i++) {
                    if (newArr[i] === newArr[i + 3]) {
                        const cardElement = document.createElement('div');
                        cardElement.className = 'hand-card1';
                        cardElement.innerHTML = `
                            <div class="hand-card-number1">æ ${mahjongMap[newArr[i]]}</div>
                        `;
                        cardElement.onclick = () => gang2Card(extra, hands, newArr[i]);
                        discardPileContainer.appendChild(cardElement);
                    }
                }
            }
        }

        if (gameState.gameAction !== ``) {
            const el = document.createElement('div');
            el.className = 'pop-text';
            el.textContent = gameState.gameAction;

            document.body.appendChild(el);

            // åŠ¨ç”»ç»“æŸåç§»é™¤èŠ‚ç‚¹
            el.addEventListener('animationend', () => {
                el.remove();
            });
        }
    }

    function playCard(hands, card) {
        if (playerNumber !== gameState.currentTurn || gameState.littleTurn !== 1) {
            return;
        }

        // if (playerNumber !== 0) {
        //     removeNumOnce(gameState.hands1, card);
        // } else {
        removeNumOnce(hands, card);
        // }
        gameState.discard.push(card);
        gameState.currentTurn = 1 - gameState.currentTurn;
        gameState.littleTurn = 0;
        gameState.gameAction = ``;
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                type: 'gameState',
                content: JSON.stringify(gameState)
            }));
        }
    }

    function sendGame() {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                type: 'gameState',
                content: JSON.stringify(gameState)
            }));
        }
    }

    function isHu(arr) {
        arr.sort((a, b) => a - b);
        if (isPairs(arr)) {
            return true
        }
        const countObj = {};
        for (const item of arr) {
            // ç¡®ä¿itemæ˜¯æ•°å­—ï¼Œé¿å…éæ•°å­—å¹²æ‰°
            const num = Number(item);
            countObj[num] = (countObj[num] || 0) + 1;
        }

        // æ­¥éª¤2ï¼šéå†æ‰€æœ‰å¯èƒ½çš„æ•°å­—ï¼Œå°è¯•ä½œä¸ºå°†ç‰Œï¼ˆæ‰£2æ¬¡ï¼‰ï¼Œåªè¦æœ‰ä¸€æ¬¡ç¬¦åˆå³è¿”å›true
        // éå†é¢‘æ¬¡å¯¹è±¡çš„é”®ï¼ˆè½¬æˆæ•°å­—æ•°ç»„ï¼Œé¿å…å­—ç¬¦ä¸²é—®é¢˜ï¼‰
        const numKeys = Object.keys(countObj).map(key => Number(key));
        for (const targetNum of numKeys) {
            // åªæœ‰é¢‘æ¬¡â‰¥2æ—¶ï¼Œæ‰èƒ½ä½œä¸ºå°†ç‰Œï¼ˆæ‰£2æ¬¡ï¼‰
            if (countObj[targetNum] < 2) continue;

            // å…³é”®ï¼šæµ…æ‹·è´åŸé¢‘æ¬¡å¯¹è±¡ï¼Œé¿å…ä¿®æ”¹åŸæ•°æ®ï¼ˆè§£å†³å¼•ç”¨ä¼ é€’é—®é¢˜ï¼‰
            const newCountObj = {...countObj};
            // æ‰£å°†ç‰Œï¼šå¯¹åº”æ•°å­—é¢‘æ¬¡å‡2
            newCountObj[targetNum] -= 2;
            // è‹¥æ‰£å®Œåä¸º0ï¼Œå¯åˆ é™¤è¯¥é”®ï¼ˆå¯é€‰ï¼Œç®€åŒ–åç»­éå†ï¼‰
            if (newCountObj[targetNum] === 0) delete newCountObj[targetNum];

            // æ­¥éª¤3ï¼šå¯¹æ‰£å®Œå°†ç‰Œçš„é¢‘æ¬¡ï¼Œå¤„ç†åˆ»å­ï¼ˆæ‰£3çš„å€æ•°ï¼‰+ é¡ºå­ï¼ˆæ‰£è¿ç»­3ä¸ªæ•°å­—ï¼‰
            // æ‹·è´æ–°çš„é¢‘æ¬¡å¯¹è±¡ç”¨äºå¤„ç†ï¼Œé¿å…éå†ä¸­ä¿®æ”¹åŸå¯¹è±¡å¯¼è‡´çš„é—®é¢˜
            const handleCountObj = {...newCountObj};
            // æŒ‰æ•°å­—å‡åºéå†ï¼ˆå¿…é¡»æ’åºï¼Œå¦åˆ™é¡ºå­å¤„ç†ä¼šä¹±åºï¼Œå¦‚å…ˆå¤„ç†5å†å¤„ç†3ä¼šå‡ºé”™ï¼‰
            const sortedNums = Object.keys(handleCountObj).map(key => Number(key)).sort((a, b) => a - b);

            for (const curNum of sortedNums) {
                let curCount = handleCountObj[curNum] || 0;
                if (curCount === 0) continue;

                // å¤„ç†åˆ»å­ï¼šæ‰£3çš„å€æ•°ï¼Œå‰©ä½™0/1/2ï¼ˆå–æ¨¡è¿ç®—æœ€ç®€æ´ï¼‰
                curCount = curCount % 3;
                handleCountObj[curNum] = curCount;
                if (curCount === 0) {
                    delete handleCountObj[curNum];
                    continue;
                }

                // æ­¥éª¤4ï¼šå¤„ç†é¡ºå­ï¼šå½“å‰é¢‘æ¬¡ä¸ºcurCountï¼Œéœ€curNum+1ã€curNum+2å„æ‰£curCount
                const next1 = curNum + 1; // ä¸‹ä¸€ä¸ªè¿ç»­æ•°å­—
                const next2 = curNum + 2; // ä¸‹ä¸‹ä¸€ä¸ªè¿ç»­æ•°å­—
                // è¾¹ç•Œåˆ¤æ–­ï¼šå¿…é¡»å­˜åœ¨è¿™ä¸¤ä¸ªæ•°å­—ï¼Œä¸”é¢‘æ¬¡â‰¥å½“å‰é¢‘æ¬¡ï¼ˆå¦åˆ™æ— æ³•ç»„æˆé¡ºå­ï¼‰
                if (handleCountObj[next1] >= curCount && handleCountObj[next2] >= curCount) {
                    // æ‰£å‡è¿ç»­æ•°å­—çš„é¢‘æ¬¡
                    handleCountObj[next1] -= curCount;
                    handleCountObj[next2] -= curCount;
                    // æ‰£å®Œåä¸º0åˆ™åˆ é™¤ï¼Œç®€åŒ–åˆ¤æ–­
                    if (handleCountObj[next1] === 0) delete handleCountObj[next1];
                    if (handleCountObj[next2] === 0) delete handleCountObj[next2];
                    // å½“å‰æ•°å­—é¢‘æ¬¡ç½®0å¹¶åˆ é™¤
                    delete handleCountObj[curNum];
                } else {
                    // æ— æ³•ç»„æˆåˆ»å­/é¡ºå­ï¼Œæœ¬æ¬¡å°†ç‰Œå°è¯•å¤±è´¥ï¼Œè·³å‡ºå¾ªç¯
                    break;
                }
            }

            // æ­¥éª¤5ï¼šåˆ¤æ–­æœ¬æ¬¡å°†ç‰Œå°è¯•æ˜¯å¦æˆåŠŸï¼šå¤„ç†åé¢‘æ¬¡å¯¹è±¡ä¸ºç©ºï¼ˆæ‰€æœ‰é¢‘æ¬¡æ‰£å®Œï¼‰
            if (Object.keys(handleCountObj).length === 0) {
                return true;
            }
        }
        return false;
    }

    function isPairs(arr) {
        if (!Array.isArray(arr) || arr.length !== 14) return false;
        const countObj = {};
        for (const item of arr) {
            countObj[item] = (countObj[item] || 0) + 1;
        }
        // éå†å¯¹è±¡å€¼ï¼Œåˆ¤æ–­æ˜¯å¦å…¨ä¸º2
        return Object.values(countObj).every(count => (count === 2 || count === 4));
    }

    function removeNumOnce(arr, num) {
        // 1. æ‰¾åˆ°æŒ‡å®šæ•°å­—çš„**ç¬¬ä¸€ä¸ª**åŒ¹é…ç´¢å¼•ï¼ˆindexOfæ‰¾ä¸åˆ°è¿”å›-1ï¼‰
        const index = arr.indexOf(num);
        // 2. ç´¢å¼•æœ‰æ•ˆï¼ˆä¸æ˜¯-1ï¼‰æ—¶ï¼Œåˆ é™¤è¯¥ç´¢å¼•çš„1ä¸ªå…ƒç´ 
        if (index !== -1) {
            arr.splice(index, 1); // splice(ç´¢å¼•, åˆ é™¤ä¸ªæ•°)ï¼šåŸåœ°ä¿®æ”¹æ•°ç»„
        }
        arr.sort((a, b) => a - b);
        // 3. è¿”å›å¤„ç†åçš„æ•°ç»„ï¼ˆæ— åŒ¹é…é¡¹åˆ™è¿”å›åŸæ•°ç»„ï¼‰
        return arr;
    }

    function connect() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws`;

        ws = new WebSocket(wsUrl);

        ws.onopen = function () {
            // å‘é€è¿æ¥ä¿¡æ¯
            ws.send(JSON.stringify({
                type: 'connect',
                roomID: roomID,
                userID: currentUser.id,
                username: currentUser.username
            }));

            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            document.getElementById('messageInput').focus();
        };

        ws.onmessage = function (event) {
            const msg = JSON.parse(event.data);

            switch (msg.type) {
                case 'message':
                    addChatMessage(msg);
                    break;
                case 'system':
                    addGameMessage(msg.content);
                    break;
                case 'userlist':
                    updateUserList(JSON.parse(msg.content));
                    break;
                case 'history':
                    processHistory(JSON.parse(msg.content));
                    break;
                case 'error':
                    showErrorMessage(msg.content);
                    break;
                case 'gameState':
                    updateGameState(JSON.parse(msg.content));
                    break;
                case 'playerNumber':
                    if (msg.playerNumber !== 1) {
                        playerNumber = 0
                    } else {
                        playerNumber = 1
                    }
                    break;
            }
        };

        ws.onerror = function (error) {
            console.error('è¿æ¥é”™è¯¯:', error);
            addGameMessage('è¿æ¥é”™è¯¯ï¼Œæ­£åœ¨å°è¯•é‡è¿...');
        };

        ws.onclose = function () {
            addGameMessage('è¿æ¥å·²æ–­å¼€ï¼Œæ­£åœ¨å°è¯•é‡è¿...');
            setTimeout(connect, 2000);
        };
    }

    function updateGameState(state) {
        gameState = state;
        if (gameState.isNew) {
            isNewGame = true;
            readyBtn.innerText = `ç‚¹å‡»å‡†å¤‡`;
            readyBtn.disabled = false;
            gameState.isNew = false;
        }
        if (!isNewGame) {
            updateHandCards();
        }
    }

    function processHistory(historyMessages) {
        if (!hasReceivedHistory && historyMessages.length > 0) {
            // æ˜¾ç¤ºå†å²æ¶ˆæ¯åˆ†éš”çº¿
            addHistoryInfo(`ğŸ“œ æ˜¾ç¤ºæœ€è¿‘çš„ ${historyMessages.length} æ¡èŠå¤©è®°å½•`);

            // æŒ‰æ—¶é—´é¡ºåºæ˜¾ç¤ºå†å²æ¶ˆæ¯
            historyMessages.forEach(msg => {
                if (msg.type === 'message') {
                    addChatMessage(msg, true);
                }
            });

            addHistoryInfo('âœ¨ ä»¥ä¸Šæ˜¯å†å²æ¶ˆæ¯ï¼Œå¼€å§‹èŠå¤©å§ï¼');
            hasReceivedHistory = true;
        }
    }

    function sendMessage() {
        const input = document.getElementById('messageInput');
        const content = input.value.trim();

        if (content && ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                type: 'message',
                content: content
            }));

            input.value = '';
            input.focus();
        }
    }

    function showRenameModal() {
        const modal = document.getElementById('renameModal');
        const input = document.getElementById('renameInput');

        input.value = currentUser.username;
        modal.style.display = 'flex';
        input.focus();
    }

    function hideRenameModal() {
        document.getElementById('renameModal').style.display = 'none';
    }

    function renameUser() {
        const newName = document.getElementById('renameInput').value.trim();

        if (!newName) {
            alert('è¯·è¾“å…¥ç©å®¶åç§°');
            return;
        }

        if (newName.length > 20) {
            alert('ç©å®¶åç§°ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦');
            return;
        }

        if (newName === currentUser.username) {
            hideRenameModal();
            return;
        }

        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                type: 'rename',
                content: newName
            }));

            localStorage.setItem('chat_username', newName);
            currentUser.username = newName;
            currentUser.color = generateUserColor(currentUser.id);
            updateUserDisplay();

            hideRenameModal();
        }
    }

    function addChatMessage(msg, isHistory = false) {
        const messages = document.getElementById('messages');
        const messageDiv = document.createElement('div');

        const isOwnMessage = msg.userID === currentUser.id;
        messageDiv.className = isOwnMessage ? 'message chat own' : 'message chat other';

        if (!isOwnMessage) {
            messageDiv.style.borderLeftColor = msg.color;
        }

        if (isHistory) {
            messageDiv.style.opacity = '0.7';
        }

        const time = new Date(msg.time).toLocaleTimeString([], {
            hour: '2-digit',
            minute: '2-digit'
        });

        messageDiv.innerHTML = `
            <div class="message-header">
                <span class="message-username" style="color: ${isOwnMessage ? 'inherit' : msg.color}">
                    ${msg.username}${msg.playerNumber ? ` (#${msg.playerNumber})` : ''}
                </span>
                <span class="message-time">${time}</span>
            </div>
            <div class="message-content">${msg.content}</div>
        `;

        messages.appendChild(messageDiv);

        // æ»šåŠ¨åˆ°åº•éƒ¨
        messages.scrollTop = messages.scrollHeight;
    }

    function addGameMessage(text) {
        const messages = document.getElementById('messages');
        const messageDiv = document.createElement('div');

        messageDiv.className = 'message system-game';
        messageDiv.innerHTML = `<div class="message-content">ğŸ® ${text}</div>`;

        messages.appendChild(messageDiv);

        // æ»šåŠ¨åˆ°åº•éƒ¨
        messages.scrollTop = messages.scrollHeight;
    }

    function addHistoryInfo(text) {
        const messages = document.getElementById('messages');
        const messageDiv = document.createElement('div');

        messageDiv.className = 'message history-info';
        messageDiv.innerHTML = `<div class="message-content">${text}</div>`;

        messages.appendChild(messageDiv);
    }

    function showErrorMessage(text) {
        const messages = document.getElementById('messages');
        const messageDiv = document.createElement('div');

        messageDiv.className = 'message error';
        messageDiv.innerHTML = `<div class="message-content">${text}</div>`;

        messages.appendChild(messageDiv);

        // 3ç§’åè·³è½¬å›ä¸»é¡µ
        setTimeout(() => {
            window.location.href = '/';
        }, 3000);
    }

    function updateUserList(users) {
        userList = users;
        const onlineCountElement = document.getElementById('onlineCount');
        onlineCountElement.textContent = users.length;

        updateUserListDisplay(users);
    }
</script>
</body>
</html>